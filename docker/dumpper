FROM docker.elastic.co/logstash/logstash:6.1.2
USER root
ENV ROOT=/root/api
WORKDIR $ROOT
COPY . .

# Install Python.
RUN \
  echo -e "\n\e[32mapt-get Update.\033[0m\n" && \
  yum update -y && \
  yum install -y python && \
  curl "https://bootstrap.pypa.io/get-pip.py" -o "get-pip.py" && \
  python get-pip.py && \
  yum install -y wget


WORKDIR $ROOT/temp
RUN \
  echo -e "\n\e[32mDownloading dumps.\033[0m\n" && \
  wget https://nyc3.digitaloceanspaces.com/imdbnator/imdb.movies.tar.gz && \
  wget https://nyc3.digitaloceanspaces.com/imdbnator/tmdb.movies.tar.gz && \
  tar xvzf imdb.movies.tar.gz && \
  tar xvzf tmdb.movies.tar.gz


WORKDIR $ROOT/scripts
RUN \
  echo -e "\n\e[32mInstalling python.\033[0m\n" && \
  pip install -r requirements.txt

RUN \
  echo -e "\n\e[32mParsing dumps.\033[0m\n" && \
  python parser.py tmdb movies $ROOT/temp/tmdb.movies $ROOT/temp && \
  python parser.py imdb movies $ROOT/temp/imdb.movies $ROOT/temp

WORKDIR $ROOT
CMD ["bash"]
